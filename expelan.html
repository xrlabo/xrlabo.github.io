<html lang="ja">
    <head>
        <meta charset="utf-8" />

		<!-- Embed latest version of Babylon.js. -->
		<!-- <script src="https://cdn.babylonjs.com/babylon.js"></script> -->
        <script src="./Babylon.js/babylon.js"></script>

		<!-- Embed Babylon loader scripts for .gltf and other filetypes. -->
		<script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>

		<!-- Embed pep.js for consistent cross-browser pointer events. -->
		<script src="https://code.jquery.com/pep/0.4.3/pep.js"></script>

        <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>

        <!-- <script src="./Babylon.js/dist/gui/babylon.gui.min.js"></script> -->
        <!-- <script src="./Babylon.js/dist/gui/babylon.gui.js.map"></script> -->
        <title>Experiment for VRSJ</title>
    </head>

    <body>
        <button onclick="resettime_clicked();" style="width: 150px; height: 50px; margin: 10px"><font size="5">Reset time</font></button><br>
        <!-- <input id="mic_on_off_button" type="button" onclick="mic_on_off();" value="mic on" style="width: 100px; height: 50px; margin: 10px; font-size: 20px"> -->
        <!-- <input type="radio" name="mic_on_off" onclick="mic_on_off_clicked()" checked style="width: 100px; height: 50px;"><font size="7">mic on</font> -->
        <!-- <input type="radio" name="mic_on_off" onclick="mic_on_off_clicked()" style="width: 100px; height: 50px;"><font size="7">mic off</font><br> -->
        <!-- <button onclick="disconnect_clicked()">切断</button> -->
        <input type="radio" name="expe_mode" onclick="expe_mode_clicked()" checked style="width: 100px; height: 50px;"><font size="7">self change</font>
        <input type="radio" name="expe_mode" onclick="expe_mode_clicked()" style="width: 100px; height: 50px;"><font size="7">half</font>
        <input type="radio" name="expe_mode" onclick="expe_mode_clicked()" style="width: 100px; height: 50px;"><font size="7">alternative</font><br>

        <!-- <input type="radio" name="change_video" onclick="change_video_clicked()" checked style="width: 100px; height: 50px;"><font size="7">Segway</font> -->
        <!-- <input type="radio" name="change_video" onclick="change_video_clicked()" style="width: 100px; height: 50px;"><font size="7">A1</font><br> -->
        <input type="radio" name="start_stop_log" onclick="start_stop_log_clicked()" style="width: 100px; height: 50px;"><font size="7">start log</font>
        <input type="radio" name="start_stop_log" onclick="start_stop_log_clicked()" checked style="width: 100px; height: 50px;"><font size="7">stop log</font>

        <div id="remote-videos">

            <video id="remoteVideo_left" controls style="border: 1px solid gray; width: 49.5%; float: left;">
                <track id="jaTrack" kind="subtitles" srclang="ja" label="テスト" default="default">
            </video>
            <video id="remoteVideo_right" controls style="border: 1px solid gray; width: 49.5%; float: left;"></video>
            <video id="remoteVideo_segway_rear" controls style="border: 1px solid gray; width: 49.5%; float: left;"></video>
            <video id="remoteVideo_right_A1" controls style="border: 1px solid gray; width: 49.5%; float: left;"></video>
            <video id="segway_control_dummy_video" style="display: none;"></video>
            <video id="a1_control_dummy_video" style="display: none;"></video>
        </div>

        <main style="margin: 0; padding: 0;">
            <div class="VelocityStatus" style="float: left; width: 50%; height: 250px; background-color: #ddd;">
                Unitree A1 status <br>
                <font size="4">
                    <pre><div id="a1ss"></div></pre>
                </font>
                <br>
            </div>
            <div class="SegwayStatusStamped" style="float: right; width: 50%; height: 250px; background-color: #eee;">
                Segway RMP status <br>
                <font size="4">
                    <pre><div id="sgss"></div></pre>
                </font>
                <br>
            </div>
        </main>

		<!-- Babylon.js のレンダリング内容を表示するための Canvas タグ-->
		<canvas id="renderCanvas" style="border: 3px solid gray; width: 100%; float: left; touch-action: none; display: inline-block;"></canvas>
        <script type="text/javascript">
            let timer;
            document.addEventListener('keydown', (event) => {
                if (segway_local_control_recvonly.dataChannel) {
                    if (segway_local_control_recvonly.dataChannel.readyState == 'open') {
                        segway_local_control_recvonly.dataChannel.send(new Uint8Array([0x99, 0x99, 0x99, 0x99]));
                    }
                }
                if (a1_local_control_recvonly.dataChannel) {
                    if (a1_local_control_recvonly.dataChannel.readyState == 'open') {
                        a1_local_control_recvonly.dataChannel.send(new Uint8Array([0x99, 0x99, 0x99, 0x99]));
                    }
                }
                console.log(event);
                clearTimeout(timer);
                document.body.style.backgroundColor ='#ff3030';
                timer = setTimeout(bgWhite, 300);
            });

            function bgWhite() {
                document.body.style.backgroundColor ='#ffffff';
            }
            let CLOSE_DATA_CHANNEL = false;
        </script>
        <script src="./getStats.js"></script>
        <script type="text/javascript" src="./sora.js"></script>
        <script type="text/javascript">
            let segway_latch = 0;
            let segway_turn_position = 0, segway_position_x = 0, segway_position_z = 0;
            let segway_start_turn_position = 0, segway_start_position_x = 0, segway_start_position_z = 0;
            let segway_time_since_epoch, segway_ang_vel, segway_lin_vel;
            let segway_message_stamp = 0;

            let a1_auto_moving_status = 0;
            let a1_position_x = 0, a1_position_z = 0, a1_position_rot = 0;
            let a1_time_since_epoch = 0, a1_forwardSpeed = 0, a1_rotateSpeed = 0;
            let a1_start_position_x = 0, a1_start_position_z = 0, a1_start_position_rot = 0;
            let a1_message_stamp = 0;

            let header = 0x43, lin = 0, ang = 0, side = 0;

            let user_log_buff = '';
            let segway_drive_count = -1, a1_drive_count = -1;
        </script>
        <script type="text/javascript" src="./webrtc.js"></script>
        <script type="text/javascript">
            let expe_mode = 1; // 1: self change, 2: half, 3: alternative
            function expe_mode_clicked() {
                if (videoSelfChangeLoop_intervalID) {
                    clearInterval(videoSelfChangeLoop_intervalID);
                }
                if (videoHalfChangeLoop_intervalID) {
                    clearInterval(videoHalfChangeLoop_intervalID);
                }
                if (videoAlterChangeLoop_intervalID) {
                    clearInterval(videoAlterChangeLoop_intervalID);
                }

                if (document.getElementsByName('expe_mode')[0].checked) {
                    expe_mode = 1;
                    if (header == 0x43) {
                        videoDome_segway.material.alpha = 1;
                        videoDome_a1.material.alpha = 0;
                    }
                    else if (header == 0xa1) {
                        videoDome_segway.material.alpha = 0;
                        videoDome_a1.material.alpha = 1;
                    }
                    videoDome_segway.material.alphaMode = BABYLON.Engine.ALPHA_COMBINE;
                    videoDome_a1.material.alphaMode = BABYLON.Engine.ALPHA_COMBINE;
                    button.isEnabled = true;
                    button.isVisible = true;
                }
                else if (document.getElementsByName('expe_mode')[1].checked) {
                    expe_mode = 2;
                    if (header == 0x43) {
                        videoDome_segway.material.alpha = 0.8;
                        videoDome_a1.material.alpha = 0.2;
                    }
                    else if (header == 0xa1) {
                        videoDome_segway.material.alpha = 0.2;
                        videoDome_a1.material.alpha = 0.8;
                    }
                    videoDome_segway.material.alphaMode = BABYLON.Engine.ALPHA_ADD;
                    videoDome_a1.material.alphaMode = BABYLON.Engine.ALPHA_ADD;
                    button.isEnabled = true;
                    button.isVisible = true;
                }
                else if (document.getElementsByName('expe_mode')[2].checked) {
                    expe_mode = 3;
                    videoDome_segway.material.alpha = 1;
                    videoDome_a1.material.alpha = 0;
                    videoDome_segway.material.alphaMode = BABYLON.Engine.ALPHA_COMBINE;
                    videoDome_a1.material.alphaMode = BABYLON.Engine.ALPHA_COMBINE;
                    button.isEnabled = false;
                    button.isVisible = false;
                    videoAlterChangeLoop_intervalID = setInterval(videoAlterChangeLoop, 10000);
                }
            }

            let videoSelfChangeLoop_intervalID = null;
            function videoSelfChangeLoop() {
                if (header == 0x43) {
                    if (videoDome_segway.material.alpha > 0) {
                        videoDome_segway.material.alpha = videoDome_segway.material.alpha - 0.1;
                        videoDome_a1.material.alpha = videoDome_a1.material.alpha + 0.1;
                    }
                    else {
                        videoDome_segway.material.alpha = 0;
                        videoDome_a1.material.alpha = 1;
                        header = 0xa1;
                        a1_drive_count++;
                        user_log_buff += 'segway to a1 & ' + (Date.now()/1000 - 1661234080) + '\n';
                        button.textBlock.text = "Segwayに変更";
                        clearInterval(videoSelfChangeLoop_intervalID);
                        videoSelfChangeLoop_intervalID = null;
                    }
                }
                else if (header == 0xa1) {
                    if (videoDome_a1.material.alpha > 0) {
                        videoDome_a1.material.alpha = videoDome_a1.material.alpha - 0.1;
                        videoDome_segway.material.alpha = videoDome_segway.material.alpha + 0.1;
                    }
                    else {
                        videoDome_a1.material.alpha = 0;
                        videoDome_segway.material.alpha = 1;
                        header = 0x43;
                        segway_drive_count++;
                        user_log_buff += 'a1 to segway & ' + (Date.now()/1000 - 1661234080) + '\n';
                        button.textBlock.text = "犬型に変更";
                        clearInterval(videoSelfChangeLoop_intervalID);
                        videoSelfChangeLoop_intervalID = null;
                    }
                }
            }

            let videoHalfChangeLoop_intervalID = null;
            function videoHalfChangeLoop() {
                if (header == 0x43) {
                    if (videoDome_segway.material.alpha > 0.2) {
                        videoDome_segway.material.alpha = videoDome_segway.material.alpha - 0.1;
                        videoDome_a1.material.alpha = videoDome_a1.material.alpha + 0.1;
                    }
                    else {
                        videoDome_segway.material.alpha = 0.2;
                        videoDome_a1.material.alpha = 0.8;
                        header = 0xa1;
                        a1_drive_count++;
                        user_log_buff += 'segway to a1 & ' + (Date.now()/1000 - 1661234080) + '\n';
                        button.textBlock.text = "Segwayに変更";
                        clearInterval(videoHalfChangeLoop_intervalID);
                        videoHalfChangeLoop_intervalID = null;
                    }
                }
                else if (header == 0xa1) {
                    if (videoDome_a1.material.alpha > 0.2) {
                        videoDome_a1.material.alpha = videoDome_a1.material.alpha - 0.1;
                        videoDome_segway.material.alpha = videoDome_segway.material.alpha + 0.1;
                    }
                    else {
                        videoDome_a1.material.alpha = 0.2;
                        videoDome_segway.material.alpha = 0.8;
                        header = 0x43;
                        segway_drive_count++;
                        user_log_buff += 'a1 to segway & ' + (Date.now()/1000 - 1661234080) + '\n';
                        button.textBlock.text = "犬型に変更";
                        clearInterval(videoHalfChangeLoop_intervalID);
                        videoHalfChangeLoop_intervalID = null;
                    }
                }
            }

            let videoAlterChangeLoop_intervalID = null;
            function videoAlterChangeLoop() {
                videoAlterChangeSubLoop_intervalID = setInterval(videoAlterChangeSubLoop, 1000.0/10.0);
            }

            let videoAlterChangeSubLoop_intervalID = null;
            function videoAlterChangeSubLoop() {
                if (header == 0x43) {
                    if (videoDome_segway.material.alpha > 0) {
                        videoDome_segway.material.alpha = videoDome_segway.material.alpha - 0.1;
                        videoDome_a1.material.alpha = videoDome_a1.material.alpha + 0.1;
                    }
                    else {
                        videoDome_segway.material.alpha = 0;
                        videoDome_a1.material.alpha = 1;
                        header = 0xa1;
                        a1_drive_count++;
                        user_log_buff += 'segway to a1 & ' + (Date.now()/1000 - 1661234080) + '\n';
                        clearInterval(videoAlterChangeSubLoop_intervalID);
                        videoAlterChangeSubLoop_intervalID = null;
                    }
                }
                else if (header == 0xa1) {
                    if (videoDome_a1.material.alpha > 0) {
                        videoDome_a1.material.alpha = videoDome_a1.material.alpha - 0.1;
                        videoDome_segway.material.alpha = videoDome_segway.material.alpha + 0.1;
                    }
                    else {
                        videoDome_a1.material.alpha = 0;
                        videoDome_segway.material.alpha = 1;
                        header = 0x43;
                        a1_drive_count++;
                        user_log_buff += 'a1 to segway & ' + (Date.now()/1000 - 1661234080) + '\n';
                        clearInterval(videoAlterChangeSubLoop_intervalID);
                        videoAlterChangeSubLoop_intervalID = null;
                    }
                }
            }


            function start_stop_log_clicked() {
                if (document.getElementsByName('start_stop_log')[0].checked) {
                    // document.getElementsByName('start_stop_log')[0].checked = true;
                    if (header == 0x43) {
                        segway_drive_count = 0;
                        a1_drive_count = -1;
                    }
                    else if (header == 0xa1) {
                        segway_drive_count = -1;
                        a1_drive_count = 0;
                    }
                    if (expe_mode == 1) {
                        user_log_buff = 'Self Change Experience begin at ' + new Date() + ' & ' + (Date.now()/1000 - 1661234080) + '\n';
                    }
                    else if (expe_mode == 2) {
                        user_log_buff = 'Half Change Experience begin at ' + new Date() + ' & ' + (Date.now()/1000 - 1661234080) + '\n';
                    }
                    else if (expe_mode == 3) {
                        user_log_buff = 'Alternative Change Experience begin at ' + new Date() + ' & ' + (Date.now()/1000 - 1661234080) + '\n';
                    }
                }
                else if (document.getElementsByName('start_stop_log')[1].checked) {
                    // document.getElementsByName('start_stop_log')[1].checked = true;
                    var blob = new Blob([user_log_buff], {type:"text"}); //配列に上記の文字列(str)を設定
                    var link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    if (expe_mode == 1) {
                        link.download = new Date() + "_self_user_log.txt";
                    }
                    else if (expe_mode == 2) {
                        link.download = new Date() + "_half_user_log.txt";
                    }
                    else if (expe_mode == 3) {
                        link.download = new Date() + "_alter_user_log.txt";
                    }
                    link.click();
                }
            }


            const debug = true;
            // const sora = Sora.connection("wss://sora.ikeilabsora.0am.jp/signaling", debug);
            const sora = Sora.connection("ws://192.168.11.64:5000/signaling", debug);

            const options_control = {
                multistream : true,
                video : false,
                audio : true,
                dataChannelSignaling : true,
                dataChannels : [
                    {
                        label : "#sora-devtools",
                        direction : "sendrecv"
                    }
                ]
            };

            const options_audio_sendonly = {
                multistream : true,
                video : false,
                audio : true
            }

            const options_video_audio_sendrecv = {
                multistream : true,
                video : false,
                audio : true
            }

            const options_video_recvonly = {
                multistream : true,
                video : true,
                audio : true
            };

            let recvonly_chair_control = sora.recvonly("chair-control", null, options_control);
            let sendrecv_segway_right = sora.sendrecv("twincam-right", null, options_video_audio_sendrecv);
            let sendrecv_A1_right = sora.sendrecv("twincam-right-A1", null, options_video_audio_sendrecv);

            let segway_local_control_recvonly = new localrecvonly('segway_control_dummy_video', "ws://192.168.11.32:8080/ws");
            let a1_local_control_recvonly = new localrecvonly("a1_control_dummy_video", "ws://192.168.11.153:8080/ws");

            let videoStream_id_right = null;
            let videoStream_id_right_A1 = null;

            sendrecv_segway_right.on("track", (event) => {
                console.log(event);
                if (event.track.kind == "video") {
                    setTimeout(() => {
                        document.querySelector('#remoteVideo_right').srcObject = event.streams[0];
                        document.querySelector('#remoteVideo_right').autoplay = true;
                        document.querySelector('#remoteVideo_right').muted = false;
                        videoStream_id_right = event.streams[0].id;
                    }, 1500);
                    return;
                }
            });

            sendrecv_A1_right.on("track", (event) => {
                console.log(event);
                if (event.track.kind == "video") {
                    setTimeout(() => {
                        console.log(event);
                        document.querySelector('#remoteVideo_right_A1').srcObject = event.streams[0];
                        document.querySelector('#remoteVideo_right_A1').autoplay = true;
                        document.querySelector('#remoteVideo_right_A1').muted = false;
                        videoStream_id_right_A1 = event.streams[0].id;
                    }, 4000);
                    return;
                }
            });

            sendrecv_segway_right.on("removetrack", (event) => {
                if (event.target.id == videoStream_id_right) {
                    document.querySelector(`#remoteVideo_right`).srcObject = null;
                }
            });

            sendrecv_A1_right.on("removetrack", (event) => {
                if (event.target.id == videoStream_id_right_A1) {
                    document.querySelector(`#remoteVideo_right`).srcObject = null;
                }
            });


            function resettime_clicked() {
                let ltime = new Uint32Array([Date.now()/1000 - 1660000000])[0];
                segway_local_control_recvonly.dataChannel.send(new Uint8Array([0x96, ltime >> 24, ltime >> 16, ltime >> 8, ltime]));
                a1_local_control_recvonly.dataChannel.send(new Uint8Array([0x96, ltime >> 24, ltime >> 16, ltime >> 8, ltime]));
            }

            /////////////////////////////////////////////////////////////////////////


			// canvas DOM 要素を取得する
			let canvas = document.getElementById('renderCanvas');

            canvas.addEventListener("mousewheel", (event) => {
                event.preventDefault();
                console.log(event);
            });

			// Initialize Babylon.js variables.
			let	sceneToRender;
            let xrHelper;
			const createDefaultEngine = function (canvas) {
                return new BABYLON.Engine(canvas, true, {
					preserveDrawingBuffer: true,
					stencil: true
				});
            }

            const engine = createDefaultEngine(canvas);

            let RobotsLocalDataChannelLoop_intervalID = null;
            let soraChairDataChannelLoop_intervalID = null;

            let camera;
            let cameraFovDegree = 60;

            let videoDome_segway, videoDome_a1;
            let button;

            let buttonheader;

            let arrow_box;


			//Create scene and create XR experience.
			const createScene = async function() {
				//新しいシーンオブジェクトを作成する
                var scene = new BABYLON.Scene(engine);
                scene.ambientColor = new BABYLON.Color3(1, 1, 1);
                // scene.detachControl();


                camera = new BABYLON.ArcRotateCamera("ArcRotateCamera", 0, 0, 0, new BABYLON.Vector3(0, 0, 0), scene);
                camera.setTarget(new BABYLON.Vector3(0, 0, 1));
                camera.detachControl(canvas, false);

                var arrow_mat = new BABYLON.StandardMaterial("arrow_mat", scene);
                    arrow_mat.alpha = 0.3;
                    arrow_mat.ambientColor = new BABYLON.Color3(0, 1, 0);
                let front_arrow_box = BABYLON.MeshBuilder.CreateBox("arrow_box", {width: 1, height: 1, depth: 6}, scene);
                    front_arrow_box.position = new BABYLON.Vector3(0, -3, 3);
                    front_arrow_box.material = arrow_mat;
                var front_arrow_cylinder = BABYLON.MeshBuilder.CreateCylinder("arrow_cylinder", {height: 0.1, diameter: 4, tessellation: 3}, scene);
                    front_arrow_cylinder.position = new BABYLON.Vector3(0, -3, 7);
                    front_arrow_cylinder.rotation = new BABYLON.Vector3(0, -Math.PI/2.0, 0)
                    front_arrow_cylinder.material = arrow_mat;

                let videoTexture_segway_right = new BABYLON.VideoTexture("video_segway_right", document.getElementById('remoteVideo_right'), scene, true, true);
                let videoTexture_segway_left = new BABYLON.VideoTexture("video_segway_left", document.getElementById('remoteVideo_left'), scene, true, true);
                let videoTexture_a1 = new BABYLON.VideoTexture("video_a1_right", document.getElementById('remoteVideo_right_A1'), scene, true, true);

                videoDome_segway = new BABYLON.VideoDome(
                    'VideoDome',
                    document.getElementById('remoteVideo_right'),
                    {
                        resolution: 64,
                        // clickToPlay: true,
                        autoPlay: true,
                        // size: 100
                        // useDirectMapping: false
                    },
                    scene
                );
                videoDome_segway.setAbsolutePosition(new BABYLON.Vector3(0, 0, 0));
                videoDome_segway.setDirection(new BABYLON.Vector3(0, 0, 0));
                videoDome_segway.material.alpha = 1;
                // videoDome_segway.material.alphaMode = BABYLON.Engine.ALPHA_ADD;

                videoDome_a1 = new BABYLON.VideoDome(
                    'VideoDome',
                    document.getElementById('remoteVideo_right_A1'),
                    {
                        resolution: 64,
                        // clickToPlay: true,
                        autoPlay: true,
                        // size: 100
                        // useDirectMapping: false
                    },
                    scene
                );
                videoDome_a1.setAbsolutePosition(new BABYLON.Vector3(0, 0, 0));
                videoDome_a1.setDirection(new BABYLON.Vector3(0, 0, 0));
                videoDome_a1.material.alpha = 0;
                // videoDome_a1.material.alphaMode = BABYLON.Engine.ALPHA_ADD;



                var planeb = BABYLON.Mesh.CreatePlane("planeb", 1);
                    planeb.position = new BABYLON.Vector3(-1, 2, 2);
                    planeb.rotation = new BABYLON.Vector3(0, -Math.PI/6, 0);
                    var advancedTextureb = BABYLON.GUI.AdvancedDynamicTexture.CreateForMesh(planeb);

                    button = BABYLON.GUI.Button.CreateSimpleButton("but", "犬に変更");
                        button.onPointerDownObservable.add(() => {
                            if (expe_mode == 1) {
                                videoSelfChangeLoop_intervalID = setInterval(videoSelfChangeLoop, 1000.0/10.0);
                            }
                            if (expe_mode == 2) {
                                videoHalfChangeLoop_intervalID = setInterval(videoHalfChangeLoop, 1000.0/10.0);
                            }
                        });
                        button.width = "1000px";
                        button.height = "200px";
                        button.color = "white";
                        button.cornerRadius = 100;
                        button.fontSize = 80;
                        button.background = "green";
                    advancedTextureb.addControl(button);



                // Create a default environment for the scene.
				var environment = scene.createDefaultEnvironment();
                // environment.ground.parent.position.y = 0;
                // environment.ground.position.y = 0


                // Initialize XR experience with default experience helper.
				xrHelper = await scene.createDefaultXRExperienceAsync({
                    // floorMeshes: [environment.ground]
                });

                //===Stick=====================================================================================================
                //==============================================================================================================
				if (!xrHelper.baseExperience) {
					// XR support is unavailable.
					console.log('WebXR support is unavailable');

				}
                else {
					// XR support is available; proceed.

                    xrHelper.teleportation.rotationAngle = 0;

                    // xrHelper.input.xrCamera.inputs.attached.mouse.detachControl();
                    // xrHelper.input.xrCamera.cameraRotation = new BABYLON.Vector2(0, 0);

                    xrHelper.input.xrCamera.setTarget(new BABYLON.Vector3(0, 0, 1));

                    // xrHelper.input.xrCamera.inputs.detachElement(true);

                    // xrHelper.input.xrCamera.inputs.remove(xrHelper.input.xrCamera.inputs.attached.mouse);

                    // xrHelper.input.xrCamera.inputs.attached.mouse.touchEnabled = false;
                    // xrHelper.input.xrCamera.inputs.attached.mouse._allowCameraRotation = false;

                    // xrHelper.input.onControllerRemovedObservable.add(() => {
                    //
                    // });

                    // xrHelper.input.xrCamera.inputs.clear();

                    xrHelper.teleportation.rotationEnabled = false;

                    xrHelper.input.onControllerAddedObservable.add((controller) => {
                        if (RobotsLocalDataChannelLoop_intervalID == null) {
                            RobotsLocalDataChannelLoop_intervalID = setInterval(RobotsLocalDataChannelLoop, 1000.0/20.0);
                            RobotsLocalDataChannelLoop();
                        }
                        if (soraChairDataChannelLoop_intervalID == null) {
                            soraChairDataChannelLoop_intervalID = setInterval(soraChairDataChannelLoop, 1000.0/10.0);
                            soraChairDataChannelLoop();
                        }
                        controller.onMotionControllerInitObservable.add((motionController) => {
                            if (motionController.handness === 'right') {
                                const xr_ids = motionController.getComponentIds();
                                let thumbstickComponent = motionController.getComponent(xr_ids[2]);
                                thumbstickComponent.onAxisValueChangedObservable.add((axes) => {
                                    // console.log(ang);
                                    if (header == 0x43) {
                                        side = 0;
                                        lin = -axes.y;
                                        ang = -axes.x;
                                    }

                                    if (header == 0xa1) {
                                        side = 0;
                                        lin = -axes.y;
                                        ang = -axes.x;
                                    }

                                });
                                let triggerComponent = motionController.getComponent(xr_ids[0]);//xr-standard-trigger
                                triggerComponent.onButtonStateChangedObservable.add((event) => {
                                    // side = -event._currentValue;
                                });

                                let abuttonComponent = motionController.getComponent(xr_ids[3]);//a-button
                                abuttonComponent.onButtonStateChangedObservable.add(() => {
                                    if (abuttonComponent.pressed) {
                                        if (segway_local_control_recvonly.dataChannel) {
                                            if (segway_local_control_recvonly.dataChannel.readyState == 'open') {
                                                segway_local_control_recvonly.dataChannel.send(new Uint8Array([0x99, 0x99, 0x99, 0x99]));
                                            }
                                        }
                                        if (a1_local_control_recvonly.dataChannel) {
                                            if (a1_local_control_recvonly.dataChannel.readyState == 'open') {
                                                a1_local_control_recvonly.dataChannel.send(new Uint8Array([0x99, 0x99, 0x99, 0x99]));
                                            }
                                        }
                                    }
                                });
                            }
                            if (motionController.handness === 'left') {
                                const xr_ids = motionController.getComponentIds();
                                let thumbstickComponent = motionController.getComponent(xr_ids[2]);
                                thumbstickComponent.onAxisValueChangedObservable.add((axes) => {
                                    // if (header == 0x43) {
                                    //     side = 0;
                                    //     lin = -axes.y;
                                    //     ang = -axes.x;
                                    // }
                                    // if (header == 0xa1) {
                                    //     side = 0;
                                    //     lin = -axes.y;
                                    //     ang = -axes.x;
                                    // }
                                });
                                let triggerComponent = motionController.getComponent(xr_ids[0]);//xr-standard-trigger
                                triggerComponent.onButtonStateChangedObservable.add((event) => {
                                    // side = event._currentValue;
                                });
                            }
                        });
                    });

                    xrHelper.baseExperience.onStateChangedObservable.add((state) => {
                        camera.alpha = -Math.PI / 2;
                        camera.beta = Math.PI / 2;
                        if(state === BABYLON.WebXRState.IN_XR){

                        }
                        else if (state === BABYLON.WebXRState.NOT_IN_XR) {
                            lin = 0;
                            ang = 0;
                            side = 0;
                            clearInterval(RobotsLocalDataChannelLoop_intervalID);
                            RobotsLocalDataChannelLoop_intervalID = null;
                            clearInterval(soraChairDataChannelLoop_intervalID);
                            soraChairDataChannelLoop_intervalID = null;
                            recvonly_chair_control.sendMessage("#sora-devtools", new Uint8Array([ 0xcc, 0x00 ]));
                            if (segway_local_control_recvonly.dataChannel) {
                                if (segway_local_control_recvonly.dataChannel.state == 'open') {
                                    segway_local_control_recvonly.dataChannel.send(new Uint8Array([header, 0, 0, 0]));
                                    segway_local_control_recvonly.dataChannel.send(new Uint8Array([0xe0, 0x00, 0x00]));
                                }
                            }
                            if (a1_local_control_recvonly.dataChannel) {
                                if (a1_local_control_recvonly.dataChannel.state == 'open') {
                                    a1_local_control_recvonly.dataChannel.send(new Uint8Array([0xa1, 0, 0, 0]));
                                }
                            }
                            if (camera.inputs.attached.gamepad) {
                                camera.inputs.attached.gamepad.detachControl();
                            }
                        }
                        console.log(state);
                    });

				}

                return scene;
            }

			// Create scene.
			scene = createScene();
			scene.then(function (returnedScene) {
				sceneToRender = returnedScene;
			});
            engine.runRenderLoop(function () {
				if (sceneToRender) {
					sceneToRender.render();
				}
			});
            // engine.runRenderLoop(function () {
			// 	scene.render();
			// });


			// Handle browser resize.
			window.addEventListener('resize', function () {
				engine.resize();
			});

            // let localStream_for_A1, localStream_for_segway;
            let localStream;

            function connect_clicked() {
                navigator.mediaDevices
                .getUserMedia({ audio: true, video: false })
                .then((stream) => {
                    localStream = stream;
                    console.log(stream);
                    console.log(stream);
                    sendrecv_segway_right.connect(localStream);
                    sendrecv_A1_right.connect(localStream);
                    user_audio_sendonly.connect(localStream);
                    // if (document.getElementsByName('mic_on_off')[0].checked) {
                    //     localStream.getAudioTracks()[0].enabled = true;
                    // }
                    // else {
                    //     localStream.getAudioTracks()[0].enabled = false;
                    // }
                    localStream.getAudioTracks()[0].enabled = true;
                })
                .catch((e) => {
                     console.error(e);
                });

                recvonly_chair_control.connect();

                // setTimeout(() => {
                //     segway_local_video_recvonly_left.connect();
                // }, 500);
                // setTimeout(() => {
                //     a1_local_video_recvonly_right.connect();
                // }, 1000);

                setTimeout(() => {
                    a1_local_control_recvonly.connect();
                }, 1500);
                setTimeout(() => {
                    segway_local_control_recvonly.connect();
                }, 2000);
            }

            setTimeout(() => {
                connect_clicked();
            }, 1000);

            function mic_on_off_clicked() {
                if (document.getElementsByName('mic_on_off')[0].checked) {
                    localStream.getAudioTracks()[0].enabled = true;
                }
                else {
                    localStream.getAudioTracks()[0].enabled = false;
                }
            }

            function RobotsLocalDataChannelLoop() {
                if (header == 0x43) {
                    if (segway_local_control_recvonly.dataChannel.readyState == 'open') {
                        segway_local_control_recvonly.dataChannel.send(new Uint8Array([ header, 127*side, 127*ang, 127*lin ]));
                    }
                }
                else if (header == 0xa1) {
                    if (a1_local_control_recvonly.dataChannel.readyState == 'open') {
                        a1_local_control_recvonly.dataChannel.send(new Uint8Array([ header, 127*side, 127*ang, 127*lin ]));
                    }
                }
            }

            let old_segway_message_stamp = 0;
            let old_a1_message_stamp = 0;
            let quit_count = 0;

            function soraChairDataChannelLoop() {
                if (recvonly_chair_control.signalingSwitched) {
                //     if (header == 0x43) {
                //         if ((segway_latch == 3 && (Math.abs(lin) > 0.15 || Math.abs(ang) > 0.15)) || segway_latch == 4 ) {
                //             if (segway_message_stamp > old_segway_message_stamp) {
                //                 recvonly_chair_control.sendMessage("#sora-devtools", new Uint8Array([ 0xcc, 0x01 ]));
                //                 old_segway_message_stamp = segway_message_stamp;
                //                 quit_count = 0;
                //             }
                //             else if (quit_count < 3000) {
                //                 quit_count++;
                //             }
                //             else {
                //                 recvonly_chair_control.sendMessage("#sora-devtools", new Uint8Array([ 0xcc, 0x00 ]));
                //                 segway_latch = 3;
                //             }
                //         }
                //         else {
                //             recvonly_chair_control.sendMessage("#sora-devtools", new Uint8Array([ 0xcc, 0x00 ]));
                //         }
                //     }
                //     if (header == 0xa1) {
                //         if ((a1_auto_moving_status == 0 && (Math.abs(ang) > 0.2 || Math.abs(lin) > 0.2)) || a1_auto_moving_status != 0) {
                //             if (a1_message_stamp > old_a1_message_stamp) {
                //                 recvonly_chair_control.sendMessage("#sora-devtools", new Uint8Array([ 0xcc, 0x01 ]));
                //                 old_a1_message_stamp = a1_message_stamp;
                //                 quit_count = 0;
                //             }
                //             else if (quit_count < 3000) {
                //                 quit_count++;
                //             }
                //             else {
                //                 recvonly_chair_control.sendMessage("#sora-devtools", new Uint8Array([ 0xcc, 0x00 ]));
                //                 a1_auto_moving_status = 0;
                //             }
                //         }
                //         else {
                //             recvonly_chair_control.sendMessage("#sora-devtools", new Uint8Array([ 0xcc, 0x00 ]));
                //         }
                //     }
                // }
                if (header == 0x43) {
                    if (Math.abs(lin) > 0.1 || Math.abs(ang) > 0.1) {
                        recvonly_chair_control.sendMessage("#sora-devtools", new Uint8Array([ 0xcc, 0x01 ]));
                    }
                    else {
                        recvonly_chair_control.sendMessage("#sora-devtools", new Uint8Array([ 0xcc, 0x00 ]));
                    }
                }
                if (header == 0xa1) {
                    if (Math.abs(ang) > 0.1 || Math.abs(lin) > 0.1) {
                        recvonly_chair_control.sendMessage("#sora-devtools", new Uint8Array([ 0xcc, 0x01 ]));
                    }
                    else {
                        recvonly_chair_control.sendMessage("#sora-devtools", new Uint8Array([ 0xcc, 0x00 ]));
                    }
                }
            }
            }

            setInterval(observe_CLOSE_DATA_CHANNEL, 10000);
            function observe_CLOSE_DATA_CHANNEL() {
                if (CLOSE_DATA_CHANNEL) {
                    connect_clicked();
                }
            }
        </script>
    </body>
</html>
